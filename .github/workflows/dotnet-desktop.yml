name: .NET Desktop (Windows Only)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  Solution_Name: CleanArchitecture.slnx

jobs:
  build_test_windows:
    name: Build & Test (Windows) - ${{ matrix.configuration }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        configuration: [ Debug, Release ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK (with NuGet cache)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
          cache: true
          cache-dependency-path: |
            **/packages.lock.json
            **/*.csproj
            NuGet.config

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore (Solution)
        shell: pwsh
        run: |
          msbuild "$env:Solution_Name" /t:Restore /v:m /nologo

      - name: Build (Solution)
        shell: pwsh
        run: |
          msbuild "$env:Solution_Name" /t:Build /p:Configuration=${{ matrix.configuration }} /v:m /nologo

      - name: Test (parallel, all test projects)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

          $testProjects = Get-ChildItem -Recurse -Filter *.csproj | Where-Object {
            $_.Name -match '\.(UnitTests|IntegrationTests|ArchitectureTests)\.csproj$'
          } | Sort-Object FullName

          if (-not $testProjects) {
            throw "No test projects found matching *.UnitTests.csproj / *.IntegrationTests.csproj / *.ArchitectureTests.csproj"
          }

          Write-Host "Found $($testProjects.Count) test projects."

          # Throttle parallel project execution to avoid resource exhaustion on the runner.
          $throttle = 4
          $jobs = New-Object System.Collections.Generic.List[object]

          function Start-TestJob([string]$ProjectPath, [string]$Configuration) {
            Start-Job -ScriptBlock {
              param($proj, $cfg)

              Write-Host "Running tests: $proj"

              dotnet test "$proj" `
                --configuration $cfg `
                --no-build `
                --verbosity normal

              exit $LASTEXITCODE
            } -ArgumentList $ProjectPath, $Configuration
          }

          foreach ($proj in $testProjects) {

            # Wait until we have a free slot
            while ( ($jobs | Where-Object { $_.State -eq 'Running' }).Count -ge $throttle ) {
              Start-Sleep -Seconds 1
              $jobs = @($jobs | ForEach-Object { Receive-Job -Job $_ -Keep -ErrorAction SilentlyContinue; $_ })
            }

            $job = Start-TestJob -ProjectPath $proj.FullName -Configuration "${{ matrix.configuration }}"
            $jobs.Add($job) | Out-Null
          }

          # Wait for all jobs to finish
          Wait-Job -Job $jobs | Out-Null

          # Collect results + output
          $failed = @()
          foreach ($job in $jobs) {
            # Emit output to log
            Receive-Job -Job $job -Keep | Write-Host

            if ($job.State -ne 'Completed') {
              $failed += $job
              continue
            }

            if ($job.ChildJobs[0].JobStateInfo.Reason) {
              # Non-terminating exceptions may bubble here
              $failed += $job
              continue
            }

            if ($job.ChildJobs[0].ExitCode -ne 0) {
              $failed += $job
            }
          }

          if ($failed.Count -gt 0) {
            Write-Host "One or more test projects failed."
            foreach ($job in $failed) {
              Write-Host " - JobId $($job.Id) (State: $($job.State))"
            }
            exit 1
          }

          Write-Host "All test projects passed."

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ matrix.configuration }}
          path: |
            **/bin/${{ matrix.configuration }}/
          if-no-files-found: warn
