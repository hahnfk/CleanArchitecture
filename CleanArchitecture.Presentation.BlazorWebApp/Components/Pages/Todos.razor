@page "/todos"
@using CleanArchitecture.Application.Abstractions
@using CleanArchitecture.Application.UseCases.Todos.Commands.AddTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.CompleteTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.DeleteTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.RenameTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.ReopenTodo
@using CleanArchitecture.Application.UseCases.Todos.Queries.ListTodos
@inject IUseCase<Unit, ListTodosResponse> ListUseCase
@inject IUseCase<AddTodoRequest, AddTodoResponse> AddUseCase
@inject IUseCase<CompleteTodoRequest, Unit> CompleteUseCase
@inject IUseCase<ReopenTodoRequest, Unit> ReopenUseCase
@inject IUseCase<DeleteTodoRequest, Unit> DeleteUseCase
@inject IUseCase<RenameTodoRequest, Unit> RenameUseCase

@rendermode InteractiveServer

<h2>Todos</h2>

<div class="ca">
    <PageTitle>Todos</PageTitle>


    <div class="toolbar">
        <button class="ca-btn" @onclick="AddInlineRow">Add</button>
    </div>

    <table class="ca-table">
        <thead>
        <tr>
            <th style="width:44px;"></th>
            <th style="width:360px;">Title</th>
            <th style="width:320px;">Actions</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var m in Items)
        {
            <tr class="@(m.IsCompleted ? "row-completed" : null)">
                <td>
                    <button type="button"
                            class="toggle-btn"
                            aria-pressed="@m.IsCompleted"
                            title="Completed"
                            @onclick="() => ToggleCompleted(m)">
                    </button>
                </td>

                <td>
                    @if (!m.IsEditing)
                    {
                        <span class="title">@m.Title</span>
                    }
                    else
                    {
                        <input class="ca-input" style="min-width:180px"
                               @bind="m.EditableTitle" @bind:event="oninput"
                               @ref="m.EditorRef"
                               @onkeydown="(e) => OnEditorKeyDown(e, m)" />
                    }
                </td>

                <td>
                    @if (m.IsNew)
                    {
                        <button type="button" class="ca-btn ca-btn-cell" disabled="@(string.IsNullOrWhiteSpace(m.EditableTitle))" @onclick="() => SaveNew(m)">Save New</button>
                        <button type="button" class="ca-btn ca-btn-cell" @onclick="() => CancelNew(m)">Cancel New</button>
                    }
                    else if (m.IsEditing)
                    {
                        <button type="button" class="ca-btn ca-btn-cell" disabled="@(!CanSaveEdit(m))" @onclick="() => SaveEdit(m)">Save</button>
                        <button type="button" class="ca-btn ca-btn-cell" @onclick="() => CancelEdit(m)">Cancel</button>
                    }
                    else
                    {
                        <button type="button" class="ca-btn ca-btn-cell" @onclick="() => StartEdit(m)">Edit</button>
                        <button type="button" class="ca-btn ca-btn-danger ca-btn-cell" @onclick="() => Delete(m)">Delete</button>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<style>
    /* ===========================
       Clean Architecture UI (scoped)
       =========================== */

    /* Scope everything under .ca to avoid collisions with Bootstrap/app.css */
    .ca {
        --ca-clr-primary: #3B82F6;
        --ca-clr-primary-hover: #2563EB;
        --ca-clr-accent: #22C55E;
        --ca-clr-danger: #EF4444;
        --ca-clr-border: #DDDDDD;
        --ca-clr-row-alt: #FAFAFA;
        --ca-clr-row-hover: #F3F4F6;
        --ca-clr-muted: #666666;
        font-family: Segoe UI, Arial, Helvetica, sans-serif;
    }

        /* Layout */
        .ca .page {
            padding: 16px;
        }

        .ca .content {
            max-width: 980px;
            margin: 0 auto;
        }

        /* Buttons (primary) */
        .ca .ca-btn {
            display: inline-block;
            padding: 10px 12px;
            min-width: 72px;
            border-radius: 6px;
            border: 1px solid var(--ca-clr-primary);
            background: var(--ca-clr-primary);
            color: #fff;
            cursor: pointer;
            user-select: none;
            text-align: center;
        }

            .ca .ca-btn:hover {
                background: var(--ca-clr-primary-hover);
                border-color: var(--ca-clr-primary-hover);
            }

            .ca .ca-btn:disabled {
                opacity: .5;
                cursor: default;
            }

        /* Danger variant */
        .ca .ca-btn-danger {
            background: var(--ca-clr-danger);
            border-color: var(--ca-clr-danger);
        }

        /* Compact cell buttons for tables */
        .ca .ca-btn-cell {
            padding: 8px 10px;
            min-width: 0;
            margin: 0 4px;
        }

        /* Inputs */
        .ca .ca-input {
            padding: 6px;
            border: 1px solid var(--ca-clr-border);
            border-radius: 4px;
        }

            .ca .ca-input:focus {
                outline: none;
                border-color: var(--ca-clr-primary);
            }

        /* Table (ListView look) */
        .ca .ca-table {
            width: 100%;
            border: 1px solid var(--ca-clr-border);
            border-collapse: collapse;
        }

            .ca .ca-table th {
                text-align: left;
                background: #f5f5f5;
                padding: 8px 6px;
                border-bottom: 1px solid var(--ca-clr-border);
                font-weight: 600;
            }

            .ca .ca-table td {
                padding: 8px 6px;
                border-bottom: 1px solid var(--ca-clr-border);
            }

            .ca .ca-table tr:nth-child(2n) {
                background: var(--ca-clr-row-alt);
            }

            .ca .ca-table tr:hover {
                background: var(--ca-clr-row-hover);
            }

        /* Completed look */
        .ca .row-completed {
            opacity: .75;
            color: var(--ca-clr-muted);
        }

            .ca .row-completed .title {
                text-decoration: line-through;
            }

        /* Radio-like completed toggle (button-based, accessible) */
        .ca .toggle-btn {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #888;
            background: transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            cursor: pointer;
        }

            .ca .toggle-btn[aria-pressed="true"] {
                border-color: var(--ca-clr-accent);
                background: radial-gradient(circle at center, var(--ca-clr-accent) 0 5px, transparent 6px);
            }

            .ca .toggle-btn:disabled {
                opacity: .5;
                cursor: default;
            }

        /* Toolbar spacing */
        .ca .toolbar {
            margin-bottom: 10px;
        }
</style>

@code {

    // ViewModel-like item (kept local to the page)
    public sealed class TodoVm
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public bool IsCompleted { get; set; }

        public bool IsNew { get; set; }
        public bool IsEditing { get; set; }
        public string EditableTitle { get; set; } = "";

        // Ref to focus the input when entering edit mode
        public ElementReference EditorRef;
    }

    private List<TodoVm> Items = new List<TodoVm>();

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        var dto = await ListUseCase.Handle(Unit.Value);
        Items = dto.Items.Select(t => new TodoVm
        {
            Id = t.Id,
            Title = t.Title,
            IsCompleted = t.IsCompleted
        }).ToList();
    }

    // === Inline add ===
    private void AddInlineRow()
    {
        Items.Insert(0, new TodoVm { IsNew = true, IsEditing = true, EditableTitle = "" });
        StateHasChanged();
    }

    private bool CanSaveNew(TodoVm m) => m != null && m.IsNew && !string.IsNullOrWhiteSpace(m.EditableTitle);

    private async Task SaveNew(TodoVm m)
    {
        if (!CanSaveNew(m)) return;
        var res = await AddUseCase.Handle(new AddTodoRequest { Title = m.EditableTitle });
        m.Id = res.Id;
        m.Title = res.Title;
        m.IsNew = false;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    private void CancelNew(TodoVm m)
    {
        if (m == null) return;
        if (m.IsNew) Items.Remove(m);
    }

    // === Edit ===
    private async Task StartEdit(TodoVm? m)
    {
        if (m == null || m.IsNew) return;
        m.EditableTitle = m.Title;
        m.IsEditing = true;
        await Task.Yield();
        await m.EditorRef.FocusAsync();
    }

    private bool CanSaveEdit(TodoVm? m)
        => m != null && m.IsEditing && !m.IsNew && !string.IsNullOrWhiteSpace(m.EditableTitle) && m.EditableTitle != m.Title;

    private async Task SaveEdit(TodoVm m)
    {
        if (!CanSaveEdit(m)) return;
        await RenameUseCase.Handle(new RenameTodoRequest { TodoId = m.Id, NewTitle = m.EditableTitle });
        m.Title = m.EditableTitle;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    private void CancelEdit(TodoVm m)
    {
        if (m == null) return;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    // === Delete ===
    private async Task Delete(TodoVm m)
    {
        if (m == null || string.IsNullOrWhiteSpace(m.Id)) return;
        await DeleteUseCase.Handle(new DeleteTodoRequest { TodoId = m.Id });
        Items.Remove(m);
    }

    // === Toggle completed (radio-like) ===
    private async Task ToggleCompleted(TodoVm m)
    {
        if (string.IsNullOrWhiteSpace(m.Id)) return; // ignore unsaved row
        var desired = !m.IsCompleted;

        try
        {
            if (desired)
                await CompleteUseCase.Handle(new CompleteTodoRequest { Id = m.Id });
            else
                await ReopenUseCase.Handle(new ReopenTodoRequest { TodoId = m.Id });

            m.IsCompleted = desired;
        }
        catch
        {
            // optional: show toast
        }
    }

    // Keyboard helpers while editing
    private async Task OnEditorKeyDown(KeyboardEventArgs e, TodoVm m)
    {
        if (e.Key == "Enter")
        {
            if (m.IsNew) await SaveNew(m);
            else await SaveEdit(m);
        }
        else if (e.Key == "Escape")
        {
            if (m.IsNew) CancelNew(m);
            else CancelEdit(m);
        }
    }
}