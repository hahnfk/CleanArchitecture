@page "/todos"
@using CleanArchitecture.Application.Abstractions
@using CleanArchitecture.Application.UseCases.Todos.Commands.AddTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.CompleteTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.DeleteTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.RenameTodo
@using CleanArchitecture.Application.UseCases.Todos.Commands.ReopenTodo
@using CleanArchitecture.Application.UseCases.Todos.Queries.ListTodos
@inject IUseCase<Unit, ListTodosResponse> ListUseCase
@inject IUseCase<AddTodoRequest, AddTodoResponse> AddUseCase
@inject IUseCase<CompleteTodoRequest, Unit> CompleteUseCase
@inject IUseCase<ReopenTodoRequest, Unit> ReopenUseCase
@inject IUseCase<DeleteTodoRequest, Unit> DeleteUseCase
@inject IUseCase<RenameTodoRequest, Unit> RenameUseCase

@rendermode InteractiveServer

<h2>Todos</h2>

<div class="ca">
    <PageTitle>Todos</PageTitle>


    <div class="toolbar">
        <button class="ca-btn" @onclick="AddInlineRow">Add</button>
    </div>

    <table class="ca-table">
        <thead>
            <tr>
                <th style="width:44px;"></th>
                <th style="width:360px;">Title</th>
                <th style="width:320px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in Items)
            {
                <tr class="@(m.IsCompleted ? "row-completed" : null)">
                    <td>
                        <button type="button"
                                class="toggle-btn"
                                aria-pressed="@m.IsCompleted"
                                title="Completed"
                                @onclick="() => ToggleCompleted(m)">
                        </button>
                    </td>

                    <td>
                        @if (!m.IsEditing)
                        {
                            <span class="title">@m.Title</span>
                        }
                        else
                        {
                            <input class="ca-input" style="min-width:180px"
                                   @bind="m.EditableTitle" @bind:event="oninput"
                                   @ref="m.EditorRef"
                                   @onkeydown="(e) => OnEditorKeyDown(e, m)" />
                        }
                    </td>

                    <td>
                        @if (m.IsNew)
                        {
                            <button type="button" class="ca-btn ca-btn-cell" disabled="@(string.IsNullOrWhiteSpace(m.EditableTitle))" @onclick="() => SaveNew(m)">Save New</button>
                            <button type="button" class="ca-btn ca-btn-cell" @onclick="() => CancelNew(m)">Cancel New</button>
                        }
                        else if (m.IsEditing)
                        {
                            <button type="button" class="ca-btn ca-btn-cell" disabled="@(!CanSaveEdit(m))" @onclick="() => SaveEdit(m)">Save</button>
                            <button type="button" class="ca-btn ca-btn-cell" @onclick="() => CancelEdit(m)">Cancel</button>
                        }
                        else
                        {
                            <button type="button" class="ca-btn ca-btn-cell" @onclick="() => StartEdit(m)">Edit</button>
                            <button type="button" class="ca-btn ca-btn-danger ca-btn-cell" @onclick="() => Delete(m)">Delete</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {

    // ViewModel-like item (kept local to the page)
    public sealed class TodoVm
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public bool IsCompleted { get; set; }

        public bool IsNew { get; set; }
        public bool IsEditing { get; set; }
        public string EditableTitle { get; set; } = "";

        // Ref to focus the input when entering edit mode
        public ElementReference EditorRef;
    }

    private List<TodoVm> Items = new List<TodoVm>();

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        var dto = await ListUseCase.Handle(Unit.Value);
        Items = dto.Items.Select(t => new TodoVm
        {
            Id = t.Id,
            Title = t.Title,
            IsCompleted = t.IsCompleted
        }).ToList();
    }

    // === Inline add ===
    private void AddInlineRow()
    {
        Items.Insert(0, new TodoVm { IsNew = true, IsEditing = true, EditableTitle = "" });
        StateHasChanged();
    }

    private bool CanSaveNew(TodoVm m) => m != null && m.IsNew && !string.IsNullOrWhiteSpace(m.EditableTitle);

    private async Task SaveNew(TodoVm m)
    {
        if (!CanSaveNew(m)) return;
        var res = await AddUseCase.Handle(new AddTodoRequest { Title = m.EditableTitle });
        m.Id = res.Id;
        m.Title = res.Title;
        m.IsNew = false;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    private void CancelNew(TodoVm m)
    {
        if (m == null) return;
        if (m.IsNew) Items.Remove(m);
    }

    // === Edit ===
    private async Task StartEdit(TodoVm? m)
    {
        if (m == null || m.IsNew) return;
        m.EditableTitle = m.Title;
        m.IsEditing = true;
        await Task.Yield();
        await m.EditorRef.FocusAsync();
    }

    private bool CanSaveEdit(TodoVm? m)
        => m != null && m.IsEditing && !m.IsNew && !string.IsNullOrWhiteSpace(m.EditableTitle) && m.EditableTitle != m.Title;

    private async Task SaveEdit(TodoVm m)
    {
        if (!CanSaveEdit(m)) return;
        await RenameUseCase.Handle(new RenameTodoRequest { TodoId = m.Id, NewTitle = m.EditableTitle });
        m.Title = m.EditableTitle;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    private void CancelEdit(TodoVm m)
    {
        if (m == null) return;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    // === Delete ===
    private async Task Delete(TodoVm m)
    {
        if (m == null || string.IsNullOrWhiteSpace(m.Id)) return;
        await DeleteUseCase.Handle(new DeleteTodoRequest { TodoId = m.Id });
        Items.Remove(m);
    }

    // === Toggle completed (radio-like) ===
    private async Task ToggleCompleted(TodoVm m)
    {
        if (string.IsNullOrWhiteSpace(m.Id)) return; // ignore unsaved row
        var desired = !m.IsCompleted;

        try
        {
            if (desired)
                await CompleteUseCase.Handle(new CompleteTodoRequest { Id = m.Id });
            else
                await ReopenUseCase.Handle(new ReopenTodoRequest { TodoId = m.Id });

            m.IsCompleted = desired;
        }
        catch
        {
            // optional: show toast
        }
    }

    // Keyboard helpers while editing
    private async Task OnEditorKeyDown(KeyboardEventArgs e, TodoVm m)
    {
        if (e.Key == "Enter")
        {
            if (m.IsNew) await SaveNew(m);
            else await SaveEdit(m);
        }
        else if (e.Key == "Escape")
        {
            if (m.IsNew) CancelNew(m);
            else CancelEdit(m);
        }
    }
}