@page "/"

@inject IUseCase<Unit, ListTodosResponse> ListUseCase
@inject IUseCase<AddTodoRequest, AddTodoResponse> AddUseCase
@inject IUseCase<CompleteTodoRequest, Unit> CompleteUseCase
@inject IUseCase<ReopenTodoRequest, Unit> ReopenUseCase
@inject IUseCase<DeleteTodoRequest, Unit> DeleteUseCase
@inject IUseCase<RenameTodoRequest, Unit> RenameUseCase

@rendermode InteractiveServer

<h2>Todo List</h2>

<div>
    <PageTitle>Todos</PageTitle>

    <div class="todos-toolbar">
        <button class="todos-btn" @onclick="AddInlineRow">Add</button>
    </div>

    <table class="todos-table">
        <thead>
            <tr>
                <th style="width:44px;"></th>
                <th style="width:360px;">Title</th>
                <th style="width:320px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in Items)
            {
                <tr class="@(m.IsCompleted ? "todos-row-completed" : null)">
                    <td>
                        <button type="button"
                                class="todos-toggle-btn"
                                aria-pressed="@(m.IsCompleted ? "true" : "false")"
                                title="Completed"
                                @onclick="() => ToggleCompletedAsync(m)">
                        </button>
                    </td>

                    <td>
                        @if (!m.IsEditing)
                        {
                            <span class="title">@m.Title</span>
                        }
                        else
                        {
                            <input class="todos-input" style="min-width:180px"
                                   @bind="m.EditableTitle" @bind:event="oninput"
                                   @ref="m.EditorRef"
                                   @onkeydown="(e) => OnEditorKeyDownAsync(e, m)" />
                        }
                    </td>

                    <td>
                        @if (m.IsNew)
                        {
                            <button type="button"
                                    class="todos-btn todos-btn-cell"
                                    disabled="@(string.IsNullOrWhiteSpace(m.EditableTitle))"
                                    @onclick="() => SaveNewAsync(m)">
                                Save New
                            </button>

                            <button type="button"
                                    class="todos-btn todos-btn-cell"
                                    @onclick="() => CancelNew(m)">
                                Cancel New
                            </button>
                        }
                        else if (m.IsEditing)
                        {
                            <button type="button"
                                    class="todos-btn todos-btn-cell"
                                    disabled="@(!CanSaveEdit(m))"
                                    @onclick="() => SaveEditAsync(m)">
                                Save
                            </button>

                            <button type="button"
                                    class="todos-btn todos-btn-cell"
                                    @onclick="() => CancelEdit(m)">
                                Cancel
                            </button>
                        }
                        else
                        {
                            <button type="button"
                                    class="todos-btn todos-btn-cell"
                                    @onclick="() => StartEditAsync(m)">
                                Edit
                            </button>

                            <button type="button"
                                    class="todos-btn todos-btn-danger todos-btn-cell"
                                    @onclick="() => DeleteAsync(m)">
                                Delete
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    // ViewModel-like item (kept local to the page)
    public sealed class TodoVm
    {
        public string Id { get; set; } = "";
        public string Title { get; set; } = "";
        public bool IsCompleted { get; set; }

        public bool IsNew { get; set; }
        public bool IsEditing { get; set; }
        public string EditableTitle { get; set; } = "";

        // Ref to focus the input when entering edit mode
        public ElementReference EditorRef;
    }

    private List<TodoVm> Items = new List<TodoVm>();

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        var result = await ListUseCase.Handle(Unit.Value);
        if (result.IsSuccess && result.Value != null)
        {
            Items = result.Value.Items.Select(t => new TodoVm
            {
                Id = t.Id,
                Title = t.Title,
                IsCompleted = t.IsCompleted
            }).ToList();
        }
        else ShowErrors("Failed to load todos", result.Errors);
    }

    // === Inline add ===
    private void AddInlineRow()
    {
        Items.Insert(0, new TodoVm { IsNew = true, IsEditing = true, EditableTitle = "" });
        StateHasChanged();
    }

    private bool CanSaveNew(TodoVm m) => m != null && m.IsNew && !string.IsNullOrWhiteSpace(m.EditableTitle);

    private async Task SaveNewAsync(TodoVm m)
    {
        if (!CanSaveNew(m)) return;
        var result = await AddUseCase.Handle(new AddTodoRequest { Title = m.EditableTitle });
        if (result.IsSuccess)
        {
            var added = result.Value!;
            m.Id = added.Id;
            m.Title = added.Title;
            m.IsNew = false;
            m.IsEditing = false;
            m.EditableTitle = string.Empty;
        }
        else ShowErrors("Failed to add todo", result.Errors);
    }

    private void CancelNew(TodoVm m)
    {
        if (m == null) return;
        if (m.IsNew) Items.Remove(m);
    }

    // === Edit ===
    private async Task StartEditAsync(TodoVm? m)
    {
        if (m == null || m.IsNew) return;
        m.EditableTitle = m.Title;
        m.IsEditing = true;
        await Task.Yield();
        await m.EditorRef.FocusAsync();
    }

    private bool CanSaveEdit(TodoVm? m)
        => m != null && m.IsEditing && !m.IsNew && !string.IsNullOrWhiteSpace(m.EditableTitle) && m.EditableTitle != m.Title;

    private async Task SaveEditAsync(TodoVm m)
    {
        if (!CanSaveEdit(m)) return;
        var result = await RenameUseCase.Handle(new RenameTodoRequest { TodoId = m.Id, NewTitle = m.EditableTitle });
        if (result.IsSuccess)
        {
            m.Title = m.EditableTitle;
            m.EditableTitle = "";
            m.IsEditing = false;
        }
        else ShowErrors("Failed to rename todo", result.Errors);
    }

    private void CancelEdit(TodoVm m)
    {
        if (m == null) return;
        m.IsEditing = false;
        m.EditableTitle = "";
    }

    // === Delete ===
    private async Task DeleteAsync(TodoVm m)
    {
        if (m == null || string.IsNullOrWhiteSpace(m.Id)) return;

        if (m.IsNew) { Items.Remove(m); return; }

        var result = await DeleteUseCase.Handle(new DeleteTodoRequest { TodoId = m.Id });
        if (result.IsSuccess) Items.Remove(m);
        else ShowErrors("Failed to delete todo", result.Errors);
    }

    // === Toggle completed (radio-like) ===
    private async Task ToggleCompletedAsync(TodoVm m)
    {
         if (!m.IsCompleted)
        {
            var res = await CompleteUseCase.Handle(new CompleteTodoRequest { Id = m.Id });
            if (res.IsSuccess) m.IsCompleted = true;
            else ShowErrors("Failed to complete todo", res.Errors);
        }
        else
        {
            var res = await ReopenUseCase.Handle(new ReopenTodoRequest { TodoId = m.Id });
            if (res.IsSuccess) m.IsCompleted = false;
            else ShowErrors("Failed to reopen todo", res.Errors);
        }
    }

    // Keyboard helpers while editing
    private async Task OnEditorKeyDownAsync(KeyboardEventArgs e, TodoVm m)
    {
        if (e.Key == "Enter")
        {
            if (m.IsNew) await SaveNewAsync(m);
            else await SaveEditAsync(m);
        }
        else if (e.Key == "Escape")
        {
            if (m.IsNew) CancelNew(m);
            else CancelEdit(m);
        }
    }
}

@code {
    private string? errorText;

    /// <summary>
    /// Show a message inside the page (uses your existing alert box bound to 'errorText').
    /// </summary>
    private void Show(string caption, string text)
    {
        // Render as "Caption: message" or just the message when caption is empty.
        errorText = string.IsNullOrWhiteSpace(caption) ? text : $"{caption}: {text}";
        StateHasChanged(); // ensure the alert re-renders immediately
    }

    /// <summary>
    /// ROP helper that formats a list of errors and shows them via Show(...).
    /// </summary>
    private void ShowErrors(string caption, IReadOnlyList<CleanArchitecture.Application.Abstractions.ROP.Error> errors)
        => Show(caption, JoinErrors(errors));

    /// <summary>
    /// Keep EXACT signature as requested (compiler relies on the fully qualified type).
    /// </summary>
    private static string JoinErrors(IReadOnlyList<CleanArchitecture.Application.Abstractions.ROP.Error> errors)
        => string.Join("; ", errors.Select(e => $"{e.Code}: {e.Message}{(string.IsNullOrWhiteSpace(e.Detail) ? "" : " (" + e.Detail + ")")}"));
}

